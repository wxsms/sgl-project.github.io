
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>DP, DPA and SGLang DP Router &#8212; SGLang</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom_log.css?v=731335ad" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom_log.css?v=731335ad" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=0927e61e"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=ccdb6887"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'advanced_features/dp_dpa_smg_guide';</script>
    <link rel="icon" href="../_static/logo.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="LoRA Serving" href="lora.html" />
    <link rel="prev" title="Expert Parallelism" href="expert_parallelism.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
    <meta name="docbuild:last-update" content="Feb 26, 2026"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="SGLang - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="SGLang - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Get Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../get_started/install.html">Install SGLang</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Basic Usage</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../basic_usage/send_request.html">Sending Requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic_usage/openai_api.html">OpenAI-Compatible APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic_usage/ollama_api.html">Ollama-Compatible API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic_usage/offline_engine_api.html">Offline Engine API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic_usage/native_api.html">SGLang Native APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic_usage/sampling_params.html">Sampling Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic_usage/popular_model_usage.html">Popular Model Usage (DeepSeek, GPT-OSS, GLM, Llama, MiniMax, Qwen, and more)</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Advanced Features</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="server_arguments.html">Server Arguments</a></li>
<li class="toctree-l1"><a class="reference internal" href="hyperparameter_tuning.html">Hyperparameter Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="attention_backend.html">Attention Backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="speculative_decoding.html">Speculative Decoding</a></li>
<li class="toctree-l1"><a class="reference internal" href="structured_outputs.html">Structured Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="structured_outputs_for_reasoning_models.html">Structured Outputs For Reasoning Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="tool_parser.html">Tool Parser</a></li>
<li class="toctree-l1"><a class="reference internal" href="separate_reasoning.html">Reasoning Parser</a></li>
<li class="toctree-l1"><a class="reference internal" href="quantization.html">Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="quantized_kv_cache.html">Quantized KV Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="expert_parallelism.html">Expert Parallelism</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">DP, DPA and SGLang DP Router</a></li>
<li class="toctree-l1"><a class="reference internal" href="lora.html">LoRA Serving</a></li>
<li class="toctree-l1"><a class="reference internal" href="pd_disaggregation.html">PD Disaggregation</a></li>
<li class="toctree-l1"><a class="reference internal" href="epd_disaggregation.html">EPD Disaggregation</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipeline_parallelism.html">Pipeline Parallelism for Long Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="hicache.html">Hierarchical KV Caching (HiCache)</a></li>
<li class="toctree-l1"><a class="reference internal" href="vlm_query.html">Query VLM with Offline Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="dp_for_multi_modal_encoder.html">DP for Multi-Modal Encoder in SGLang</a></li>
<li class="toctree-l1"><a class="reference internal" href="cuda_graph_for_multi_modal_encoder.html">Cuda Graph for Multi-Modal Encoder in SGLang</a></li>
<li class="toctree-l1"><a class="reference internal" href="sgl_model_gateway.html">SGLang Model Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="deterministic_inference.html">Deterministic Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="observability.html">Observability</a></li>
<li class="toctree-l1"><a class="reference internal" href="checkpoint_engine.html">Checkpoint Engine Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="sglang_for_rl.html">SGLang for RL Systems</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Supported Models</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../supported_models/text_generation/index.html">Text Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../supported_models/retrieval_ranking/index.html">Retrieval &amp; Ranking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../supported_models/specialized/index.html">Specialized Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../supported_models/extending/index.html">Extending SGLang</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">SGLang Diffusion</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../diffusion/index.html">SGLang Diffusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diffusion/installation.html">Install SGLang-Diffusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diffusion/compatibility_matrix.html">Compatibility Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diffusion/api/cli.html">SGLang diffusion CLI Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diffusion/api/openai_api.html">SGLang Diffusion OpenAI API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diffusion/performance/index.html">Performance Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diffusion/performance/attention_backends.html">Attention Backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diffusion/performance/profiling.html">Profiling Multimodal Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diffusion/performance/cache/index.html">Caching Acceleration for Diffusion Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diffusion/performance/cache/cache_dit.html">Cache-DiT Acceleration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diffusion/performance/cache/teacache.html">TeaCache Acceleration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diffusion/support_new_models.html">How to Support New Diffusion Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diffusion/contributing.html">Contributing to SGLang Diffusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diffusion/ci_perf.html">Perf Baseline Generation Script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../diffusion/environment_variables.html">Caching Acceleration</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Hardware Platforms</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../platforms/amd_gpu.html">AMD GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../platforms/cpu_server.html">CPU Servers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../platforms/tpu.html">TPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="../platforms/nvidia_jetson.html">NVIDIA Jetson Orin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../platforms/ascend_npu_support.html">Ascend NPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../platforms/xpu.html">XPU</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/contribution_guide.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/development_guide_using_docker.html">Development Guide Using Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/development_jit_kernel_guide.html">Development Guide for JIT Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/benchmark_and_profiling.html">Benchmark and Profiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/bench_serving.html">Bench Serving Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/evaluating_new_models.html">Evaluating New Models with SGLang</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">References</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../references/faq.html">Troubleshooting and Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/environment_variables.html">Environment Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/production_metrics.html">Production Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/production_request_trace.html">Production Request Tracing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/multi_node_deployment/multi_node_index.html">Multi-Node Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/custom_chat_template.html">Custom Chat Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/frontend/frontend_index.html">Frontend Language</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/post_training_integration.html">Post-Training Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/release_lookup.html">Release Lookup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/learn_more.html">Learn More and Join the Community</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/sgl-project/sgl-project.github.io" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/sgl-project/sgl-project.github.io/blob/main/advanced_features/dp_dpa_smg_guide.md?plain=1" target="_blank"
   class="btn btn-sm btn-source-file-button dropdown-item"
   title="Show source"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="btn__text-container">Show source</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/sgl-project/sgl-project.github.io/edit/main/advanced_features/dp_dpa_smg_guide.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/sgl-project/sgl-project.github.io/issues/new?title=Issue%20on%20page%20%2Fadvanced_features/dp_dpa_smg_guide.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/advanced_features/dp_dpa_smg_guide.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>DP, DPA and SGLang DP Router</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-parallelism-dp">Data Parallelism (DP)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-characteristics">Key characteristics</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-parallelism-attention-dpa">Data Parallelism Attention (DPA)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-problem-with-tensor-parallelism-for-mla-models">The Problem with Tensor Parallelism for MLA Models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-dpa-works">How DPA Works</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#communication-patterns-in-dpa-ep"><strong>Communication patterns in DPA + EP:</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-benefits-of-dpa">Key benefits of DPA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dpa-with-expert-parallelism-for-moe">DPA with Expert Parallelism for MoE</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recommended-setup-for-deepseek">Recommended setup for DeepSeek</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#target-models">Target Models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#activation-logic">Activation Logic</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#standard-dp-for-mla-models">Standard DP for MLA models</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modern-data-parallelism-sglang-model-gateway-smg">Modern Data Parallelism SGLang Model Gateway (SMG)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#native-dp-mode">Native DP Mode</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#smg-based-dp-recommended">SMG-Based DP (Recommended)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#smg-s-performance">SMG’s Performance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#when-to-use-each">When to Use Each</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#quick-start-for-smg">Quick Start For SMG</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-balancing-policies">Load Balancing Policies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#best-practices">Best Practices</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verifying-traffic-distribution">Verifying Traffic Distribution</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reference">Reference</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="dp-dpa-and-sglang-dp-router">
<h1>DP, DPA and SGLang DP Router<a class="headerlink" href="#dp-dpa-and-sglang-dp-router" title="Link to this heading">#</a></h1>
<p>This guide explains the difference between Data Parallelism (DP) and Data Parallelism Attention (DPA), how to enable each mode correctly, and how to use the SGLang Model Gateway (SMG) for production-grade DP deployments.</p>
<section id="data-parallelism-dp">
<h2>Data Parallelism (DP)<a class="headerlink" href="#data-parallelism-dp" title="Link to this heading">#</a></h2>
<p><strong>Data Parallelism (DP)</strong> is the most common parallelism strategy that replicates the entire model across multiple GPU sets and processes different batches of requests in parallel. Each GPU set handles independent requests. With dedicated routing strategies, as we will introduce later, with those proper routing algorithms in SGLang Model Gateway, the throughput of your serving system could be multiplied nearly linearly.</p>
<section id="key-characteristics">
<h3>Key characteristics<a class="headerlink" href="#key-characteristics" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Each replica has a full copy of the model</p></li>
<li><p>Requests are distributed/scattered across replicas</p></li>
<li><p>No inter-replica communication during one request’s inference (for simple DP)</p></li>
</ul>
</section>
</section>
<section id="data-parallelism-attention-dpa">
<h2>Data Parallelism Attention (DPA)<a class="headerlink" href="#data-parallelism-attention-dpa" title="Link to this heading">#</a></h2>
<p><strong>Data Parallelism Attention (DPA)</strong>, also known as DP Attention, is an advanced parallelism strategy. While DPA provides the most significant benefits for <strong>Multi-Head Latent Attention (MLA)</strong> models (such as DeepSeek, MiniMax, Kimi-K2), it also supports <strong>standard attention models</strong> like Qwen.</p>
<section id="the-problem-with-tensor-parallelism-for-mla-models">
<h3>The Problem with Tensor Parallelism for MLA Models<a class="headerlink" href="#the-problem-with-tensor-parallelism-for-mla-models" title="Link to this heading">#</a></h3>
<p>The most common parallelism strategy for inference is <strong>Tensor Parallelism (TP)</strong>. However, TP might not be the most efficient strategy for certain models. For example, DeepSeek models use MLA and only have <strong>one KV head</strong>. If we use tensor parallelism on 8 GPUs, it will lead to:</p>
<ul class="simple">
<li><p><strong>Duplicated KV cache</strong> across all GPUs</p></li>
<li><p><strong>Unwanted memory usage</strong> that limits batch size</p></li>
<li><p><strong>Reduced throughput</strong> due to memory constraints</p></li>
</ul>
</section>
<section id="how-dpa-works">
<h3>How DPA Works<a class="headerlink" href="#how-dpa-works" title="Link to this heading">#</a></h3>
<p>DPA addresses these limitations by applying <strong>data parallelism specifically to the attention component</strong>.</p>
<table>
<tr>
<td width="50%">
<img src="../_static/image/dpa.png" alt="DPA + EP Architecture" width="100%">
</td>
<td width="50%" valign="top">
<p><strong>Each DP replica:</strong></p>
<ul class="simple">
<li><p>Processes different batches independently (can be in different forward modes: prefill, decode, or idle)</p></li>
<li><p>Maintains its own KV cache (no duplication)</p></li>
<li><p>Enables significantly larger batch sizes due to memory savings</p></li>
</ul>
</section>
</section>
<section id="communication-patterns-in-dpa-ep">
<h2><strong>Communication patterns in DPA + EP:</strong><a class="headerlink" href="#communication-patterns-in-dpa-ep" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>All2All (Dispatch)</strong>: Routes tokens to expert sub-groups based on gating decisions</p></li>
<li><p><strong>All2All (Combine)</strong>: Gathers computed results from experts back to original token positions</p></li>
</ul>
</td>
</tr>
</table>
<section id="key-benefits-of-dpa">
<h3>Key benefits of DPA<a class="headerlink" href="#key-benefits-of-dpa" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Significantly reduced KV cache memory</strong>: Each DP replica only stores KV cache for its own batches</p></li>
<li><p><strong>Larger batch sizes</strong>: Memory savings enable larger batch sizes</p></li>
<li><p><strong>Improved decoding throughput</strong>: Significant throughput gains for MLA-based models</p></li>
<li><p><strong>Independent forward modes</strong>: Each DP replica can be in different forward modes (prefill, decode, or idle) and handles its assigned batches independently during attention computation</p></li>
</ol>
</section>
<section id="dpa-with-expert-parallelism-for-moe">
<h3>DPA with Expert Parallelism for MoE<a class="headerlink" href="#dpa-with-expert-parallelism-for-moe" title="Link to this heading">#</a></h3>
<p>For MoE models like DeepSeek, DPA is <strong>often</strong> paired with Expert Parallelism (EP) for best throughput at scale. However, <strong>DPA does not require EP</strong>: you can enable DPA without EP if your deployment does not need expert sharding.</p>
<ul class="simple">
<li><p>Distribute 256+ expert weights across GPUs (cannot fit on a single GPU)</p></li>
<li><p>Enable efficient all-to-all token routing via DeepEP</p></li>
<li><p>Scale to large clusters (up to 5x throughput improvement over vanilla TP)</p></li>
</ul>
</section>
<section id="recommended-setup-for-deepseek">
<h3>Recommended setup for DeepSeek<a class="headerlink" href="#recommended-setup-for-deepseek" title="Link to this heading">#</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>-m<span class="w"> </span>sglang.launch_server<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model-path<span class="w"> </span>deepseek-ai/DeepSeek-V3<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--tp<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--dp-size<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--ep<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--enable-dp-attention<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--moe-a2a-backend<span class="w"> </span>deepep<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--moe-runner-backend<span class="w"> </span>deep_gemm
</pre></div>
</div>
<blockquote>
<div><p><strong>Note</strong>: <code class="docutils literal notranslate"><span class="pre">--dp-size</span></code> must be explicitly set when using <code class="docutils literal notranslate"><span class="pre">--enable-dp-attention</span></code>. If <code class="docutils literal notranslate"><span class="pre">dp_size</span></code> is 1 (default), DPA will be disabled.</p>
</div></blockquote>
<p>For detailed EP configuration (DeepEP, Two-Batch Overlap, EPLB), see <a class="reference internal" href="expert_parallelism.html"><span class="std std-doc">Expert Parallelism</span></a>.</p>
</section>
<section id="target-models">
<h3>Target Models<a class="headerlink" href="#target-models" title="Link to this heading">#</a></h3>
<p>DPA supports the following model architectures:</p>
<ul class="simple">
<li><p><strong>MLA (Multi-Head Latent Attention) models</strong> - where DPA provides the most significant benefits:</p>
<ul>
<li><p>DeepSeek family (DeepSeek-V2, DeepSeek-V3, DeepSeek-R1)</p></li>
<li><p>MiniMax models</p></li>
<li><p>Kimi-K2</p></li>
<li><p>Other models using MLA architecture</p></li>
</ul>
</li>
<li><p><strong>Standard attention models</strong> - also supported:</p>
<ul>
<li><p>Qwen models (see <a class="reference external" href="https://github.com/sgl-project/sglang/pull/6121">PR #6121</a>)</p></li>
</ul>
</li>
</ul>
<p>For models like Llama, with standard GQA, standard DP, or TP is typically recommended.</p>
<p>To enable DPA, add <code class="docutils literal notranslate"><span class="pre">--enable-dp-attention</span></code> to your server launch command.</p>
</section>
<section id="activation-logic">
<h3>Activation Logic<a class="headerlink" href="#activation-logic" title="Link to this heading">#</a></h3>
<p>DPA is enabled explicitly via server arguments (CLI or config). You must set both <code class="docutils literal notranslate"><span class="pre">--dp-size</span></code> and <code class="docutils literal notranslate"><span class="pre">--enable-dp-attention</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>-m<span class="w"> </span>sglang.launch_server<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model-path<span class="w"> </span>deepseek-ai/DeepSeek-V3<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--tp<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--dp-size<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--enable-dp-attention
</pre></div>
</div>
<p><strong>Important</strong>: <code class="docutils literal notranslate"><span class="pre">--dp-size</span></code> must be greater than 1 for DPA to work. When <code class="docutils literal notranslate"><span class="pre">dp_size</span> <span class="pre">==</span> <span class="pre">1</span></code> (default), <code class="docutils literal notranslate"><span class="pre">--enable-dp-attention</span></code> is automatically disabled. The constraint <code class="docutils literal notranslate"><span class="pre">tp_size</span> <span class="pre">%</span> <span class="pre">dp_size</span> <span class="pre">==</span> <span class="pre">0</span></code> must also be satisfied.</p>
</section>
<section id="standard-dp-for-mla-models">
<h3>Standard DP for MLA models<a class="headerlink" href="#standard-dp-for-mla-models" title="Link to this heading">#</a></h3>
<p>Note that MLA models, of course, also support DP. Suppose you want to enable standard DP for MLA models. First, launch each MLA model’s replica independently. You may launch these replicas one by one with DPA enabled. After launching each MLA model’s replica, launch an SMG and connect all the replicas to the SMG. A detailed explanation of SMG is as follows.</p>
</section>
</section>
<section id="modern-data-parallelism-sglang-model-gateway-smg">
<h2>Modern Data Parallelism SGLang Model Gateway (SMG)<a class="headerlink" href="#modern-data-parallelism-sglang-model-gateway-smg" title="Link to this heading">#</a></h2>
<section id="native-dp-mode">
<h3>Native DP Mode<a class="headerlink" href="#native-dp-mode" title="Link to this heading">#</a></h3>
<p>Native DP (built-in Data Parallelism) in SGLang creates multiple worker processes within a single SGLang instance, under the control of <code class="docutils literal notranslate"><span class="pre">DataParallelController</span></code> with the launching parameter of <code class="docutils literal notranslate"><span class="pre">dp-size</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Native DP mode</span>
python<span class="w"> </span>-m<span class="w"> </span>sglang.launch_server<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model-path<span class="w"> </span>meta-llama/Meta-Llama-3.1-8B-Instruct<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--dp-size<span class="w"> </span><span class="m">4</span>
</pre></div>
</div>
<p><strong>Limitations:</strong></p>
<ul class="simple">
<li><p>Built-in in-process load balancing only (e.g., <code class="docutils literal notranslate"><span class="pre">round_robin</span></code>, <code class="docutils literal notranslate"><span class="pre">total_requests</span></code>, <code class="docutils literal notranslate"><span class="pre">total_tokens</span></code>)</p></li>
<li><p>No cache-aware routing</p></li>
<li><p>Limited observability and metrics</p></li>
<li><p>No fault tolerance or circuit breakers</p></li>
<li><p>Not suitable for production workloads</p></li>
</ul>
<p>⚠️ Native DP is <strong>highly not recommended for use right now</strong>. It is only used in some ancient/outdated RL frameworks. You can use SGLang Model Gateway (SMG) to power up your data parallelism in any use case.</p>
</section>
<section id="smg-based-dp-recommended">
<h3>SMG-Based DP (Recommended)<a class="headerlink" href="#smg-based-dp-recommended" title="Link to this heading">#</a></h3>
<p>Starting from September 2024, SGLang Model Gateway, i.e., SMG, formerly named as SGLang DP Router, was built especially as a production-ready DP routing system with Rust. It starts from DP routing, but later we further expanded its scope to coordinate RL, PD Disaggregation, and other scenarios. This doc only discusses SMG’s usage in DP routing. For other usage, please refer to <a class="reference internal" href="sgl_model_gateway.html"><span class="std std-doc">SGLang Model Gateway Documentation</span></a>.</p>
<blockquote>
<div><p>To achieve the best production-level routing performance and reduce the overhead to an extreme extent, we use Rust to build SMG, but not Python, since Python is never FAST enough.</p>
</div></blockquote>
<p><strong>We strongly recommend using the SGLang Model Gateway (SMG) for production-grade Data Parallelism.</strong> SMG provides significant advantages over native DP mode.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># SMG-based DP mode (Recommended)</span>
python<span class="w"> </span>-m<span class="w"> </span>sglang_router.launch_server<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model-path<span class="w"> </span>meta-llama/Meta-Llama-3.1-8B-Instruct<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--dp-size<span class="w"> </span><span class="m">4</span>
</pre></div>
</div>
<p>⚠️ Note that <strong>SMG and Naive DP share the same launching parameter, <code class="docutils literal notranslate"><span class="pre">--dp-size</span></code></strong>. But the entrypoint of Naive DP is <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">sglang.launch_server</span></code>, and SMG’s entrypoint is <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">sglang_router.launch_server</span></code>.</p>
<p><strong>Advantages of SMG-Based DP:</strong></p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Feature</p></th>
<th class="head"><p>Native DP</p></th>
<th class="head"><p>SMG-Based DP</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Load Balancing</strong></p></td>
<td><p>Built-in in-process methods</p></td>
<td><p>Advanced policies (cache-aware, power-of-two, etc.)</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Cache Awareness</strong></p></td>
<td><p>❌ No</p></td>
<td><p>✅ Yes - significantly higher cache hit rate</p></td>
</tr>
<tr class="row-even"><td><p><strong>Throughput</strong></p></td>
<td><p>Baseline</p></td>
<td><p>Significant improvement</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Multi-Node Support</strong></p></td>
<td><p>Limited</p></td>
<td><p>✅ Full support</p></td>
</tr>
<tr class="row-even"><td><p><strong>Worker Health Monitoring</strong></p></td>
<td><p>Basic</p></td>
<td><p>✅ Circuit breakers, health checks</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Reliability</strong></p></td>
<td><p>Basic</p></td>
<td><p>✅ Retries, rate limiting, queuing</p></td>
</tr>
<tr class="row-even"><td><p><strong>Observability</strong></p></td>
<td><p>Basic metrics</p></td>
<td><p>✅ 40+ Prometheus metrics, OpenTelemetry</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Hot Worker Add/Remove</strong></p></td>
<td><p>❌ No</p></td>
<td><p>✅ Yes</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="smg-s-performance">
<h3>SMG’s Performance<a class="headerlink" href="#smg-s-performance" title="Link to this heading">#</a></h3>
<p>The cache-aware routing policy in SMG significantly improves performance for workloads with shared prefixes:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Metric</p></th>
<th class="head"><p>Without Cache-Aware</p></th>
<th class="head"><p>With Cache-Aware SMG</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Throughput (token/s)</p></td>
<td><p>82,665</p></td>
<td><p>158,596 (+92%)</p></td>
</tr>
<tr class="row-odd"><td><p>Cache Hit Rate</p></td>
<td><p>20%</p></td>
<td><p>75% (+275%)</p></td>
</tr>
</tbody>
</table>
</div>
<p><em>Benchmark from <a class="reference external" href="https://lmsys.org/blog/2024-12-04-sglang-v0-4/">SGLang v0.4 blog</a>, workload with multiple long prefix groups, 8x A100 80GB GPUs, dp-size=8</em></p>
</section>
<section id="when-to-use-each">
<h3>When to Use Each<a class="headerlink" href="#when-to-use-each" title="Link to this heading">#</a></h3>
<p><strong>Use Native DP when:</strong></p>
<ul class="simple">
<li><p>~Never use Native/Naive DP~</p></li>
<li><p>Learning material of DP routing</p></li>
</ul>
<p><strong>Use SMG-Based DP when:</strong></p>
<ul class="simple">
<li><p>In any case, when you think DP is needed</p></li>
<li><p>Production deployments</p></li>
<li><p>Multi-node distributed setups</p></li>
<li><p>Workloads with shared prefixes (high cache reuse potential)</p></li>
<li><p>You need high availability and reliability features</p></li>
<li><p>You require detailed observability and metrics</p></li>
<li><p>You want to have highly efficient RL rollout systems</p></li>
</ul>
<p>Note that for RL rollout systems, <strong>there are four crucial reasons that SMG-Based DP is far better than naive DP routing</strong>. Details can be found at <a class="reference internal" href="sglang_for_rl.html#load-balancing-router"><span class="std std-ref">Load Balancing Router in RL</span></a>.</p>
</section>
<section id="quick-start-for-smg">
<h3>Quick Start For SMG<a class="headerlink" href="#quick-start-for-smg" title="Link to this heading">#</a></h3>
<p><strong>Installation</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>sglang-router
<span class="c1"># or</span>
pip<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;sglang[all]&quot;</span>
</pre></div>
</div>
<p><strong>Option A: Co-launch Workers and SMG (Simplest)</strong></p>
<p>This is the easiest way to get started - SMG and workers are launched together:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>-m<span class="w"> </span>sglang_router.launch_server<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model-path<span class="w"> </span>meta-llama/Meta-Llama-3.1-8B-Instruct<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--dp-size<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--host<span class="w"> </span><span class="m">0</span>.0.0.0<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--port<span class="w"> </span><span class="m">30000</span>
</pre></div>
</div>
<p><strong>Option B: Separate Launch (Multi-Node)</strong></p>
<p>For distributed deployments across multiple machines:</p>
<ol class="arabic simple">
<li><p>Launch workers on each node</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Node 1</span>
python<span class="w"> </span>-m<span class="w"> </span>sglang.launch_server<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model-path<span class="w"> </span>meta-llama/Meta-Llama-3.1-8B-Instruct<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--port<span class="w"> </span><span class="m">8000</span>

<span class="c1"># Node 2</span>
python<span class="w"> </span>-m<span class="w"> </span>sglang.launch_server<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model-path<span class="w"> </span>meta-llama/Meta-Llama-3.1-8B-Instruct<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--port<span class="w"> </span><span class="m">8000</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Launch SMG pointing to workers</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>-m<span class="w"> </span>sglang_router.launch_router<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--worker-urls<span class="w"> </span>http://node1:8000<span class="w"> </span>http://node2:8000<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--policy<span class="w"> </span>cache_aware<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--host<span class="w"> </span><span class="m">0</span>.0.0.0<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--port<span class="w"> </span><span class="m">30000</span>
</pre></div>
</div>
<p><strong>Option C: Dynamic Worker Registration</strong></p>
<p>For elastic deployments where workers can be added/removed dynamically:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Launch SMG first</span>
python<span class="w"> </span>-m<span class="w"> </span>sglang_router.launch_router<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--policy<span class="w"> </span>cache_aware<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--host<span class="w"> </span><span class="m">0</span>.0.0.0<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--port<span class="w"> </span><span class="m">30000</span>

<span class="c1"># Register workers dynamically</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:30000/workers<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-d<span class="w"> </span><span class="s1">&#39;{&quot;url&quot;: &quot;http://worker1:8000&quot;}&#39;</span>

curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:30000/workers<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-d<span class="w"> </span><span class="s1">&#39;{&quot;url&quot;: &quot;http://worker2:8000&quot;}&#39;</span>
</pre></div>
</div>
</section>
<section id="load-balancing-policies">
<h3>Load Balancing Policies<a class="headerlink" href="#load-balancing-policies" title="Link to this heading">#</a></h3>
<p>SMG supports multiple load balancing policies:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Policy</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Best For</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">cache_aware</span></code></p></td>
<td><p>Combines cache locality with load balancing</p></td>
<td><p><strong>Recommended for most workloads</strong></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">round_robin</span></code></p></td>
<td><p>Cycles through workers in order</p></td>
<td><p>Simple, predictable distribution</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">random</span></code></p></td>
<td><p>Random worker selection</p></td>
<td><p>Baseline, testing</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">power_of_two</span></code></p></td>
<td><p>Samples two workers, picks lighter one</p></td>
<td><p>Low latency requirements</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Cache-Aware Policy (Default, Recommended)</strong></p>
<p>The cache-aware policy provides the best performance for most workloads:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>-m<span class="w"> </span>sglang_router.launch_router<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--worker-urls<span class="w"> </span>http://worker1:8000<span class="w"> </span>http://worker2:8000<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--policy<span class="w"> </span>cache_aware<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--cache-threshold<span class="w"> </span><span class="m">0</span>.5<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--balance-abs-threshold<span class="w"> </span><span class="m">32</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--balance-rel-threshold<span class="w"> </span><span class="m">1</span>.5<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--eviction-interval-secs<span class="w"> </span><span class="m">120</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--max-tree-size<span class="w"> </span><span class="m">67108864</span>
</pre></div>
</div>
<p><strong>How it works:</strong></p>
<ol class="arabic simple">
<li><p>Maintains an approximate radix tree for each worker based on request history</p></li>
<li><p>Routes requests to workers with the highest prefix match (cache hit)</p></li>
<li><p>Falls back to shortest-queue routing when load is imbalanced</p></li>
<li><p>Automatically evicts old entries to prevent memory overflow</p></li>
</ol>
</section>
<section id="best-practices">
<h3>Best Practices<a class="headerlink" href="#best-practices" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Start with <code class="docutils literal notranslate"><span class="pre">cache_aware</span></code> policy</strong> - It provides the best balance between cache locality and load distribution for most workloads</p></li>
<li><p><strong>Use SMG for production</strong> - Prefer <code class="docutils literal notranslate"><span class="pre">sglang_router.launch_server</span></code> over <code class="docutils literal notranslate"><span class="pre">sglang.launch_server</span></code> for better reliability and observability</p></li>
<li><p><strong>Enable health checks</strong> - Configure <code class="docutils literal notranslate"><span class="pre">--router-health-check-interval-secs</span></code> to detect and remove unhealthy workers automatically</p></li>
</ol>
<p><strong>Recommended command with best practices applied:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>-m<span class="w"> </span>sglang_router.launch_server<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--model-path<span class="w"> </span>meta-llama/Meta-Llama-3.1-8B-Instruct<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--dp-size<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--router-policy<span class="w"> </span>cache_aware<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--router-health-check-interval-secs<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--router-prometheus-port<span class="w"> </span><span class="m">10001</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--host<span class="w"> </span><span class="m">0</span>.0.0.0<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--port<span class="w"> </span><span class="m">30000</span>
</pre></div>
</div>
<p>For advanced configuration (circuit breakers, retries, Prometheus metrics, K8s integration), see <a class="reference internal" href="sgl_model_gateway.html"><span class="std std-doc">SGLang Model Gateway Documentation</span></a>.</p>
</section>
<section id="verifying-traffic-distribution">
<h3>Verifying Traffic Distribution<a class="headerlink" href="#verifying-traffic-distribution" title="Link to this heading">#</a></h3>
<p>After launching SMG, verify that traffic is being distributed correctly:</p>
<p><strong>1. Check worker status:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>http://localhost:30000/workers
</pre></div>
</div>
<p><strong>2. Check load distribution:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>http://localhost:30000/get_loads
</pre></div>
</div>
<p><strong>3. Monitor metrics (if Prometheus enabled):</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Key metrics to check</span>
smg_router_requests_total<span class="o">{</span><span class="nv">model</span><span class="o">=</span><span class="s2">&quot;...&quot;</span><span class="o">}</span>
smg_worker_requests_active<span class="o">{</span><span class="nv">worker</span><span class="o">=</span><span class="s2">&quot;...&quot;</span><span class="o">}</span>
sglang_cache_hit_rate<span class="o">{</span><span class="nv">source</span><span class="o">=</span><span class="s2">&quot;...&quot;</span><span class="o">}</span>
</pre></div>
</div>
<p>For detailed metrics and monitoring setup, see <a class="reference internal" href="sgl_model_gateway.html"><span class="std std-doc">SGLang Model Gateway Documentation</span></a>.</p>
</section>
</section>
<section id="reference">
<h2>Reference<a class="headerlink" href="#reference" title="Link to this heading">#</a></h2>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Strategy</p></th>
<th class="head"><p>Use Case</p></th>
<th class="head"><p>Key Benefit</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Native DP</strong> (<code class="docutils literal notranslate"><span class="pre">--dp-size</span></code>)</p></td>
<td><p>Never</p></td>
<td><p>Easy to understand, not rust based</p></td>
</tr>
<tr class="row-odd"><td><p><strong>SMG-Based DP</strong></p></td>
<td><p><strong>Production (recommended)</strong></p></td>
<td><p>Cache-aware routing, high availability</p></td>
</tr>
<tr class="row-even"><td><p><strong>DPA</strong> (<code class="docutils literal notranslate"><span class="pre">--dp-size</span> <span class="pre">N</span> <span class="pre">--enable-dp-attention</span></code>)</p></td>
<td><p>DeepSeek/MLA models</p></td>
<td><p>Eliminates KV cache duplication, improved throughput</p></td>
</tr>
<tr class="row-odd"><td><p><strong>DPA + EP</strong></p></td>
<td><p>DeepSeek MoE models</p></td>
<td><p>Significant throughput improvement vs vanilla TP</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Recommended production setup for DeepSeek:</strong></p>
<ol class="arabic simple">
<li><p>Enable <strong>DPA</strong> for attention layers (<code class="docutils literal notranslate"><span class="pre">--dp-size</span> <span class="pre">8</span> <span class="pre">--enable-dp-attention</span></code>)</p></li>
<li><p>Enable <strong>EP</strong> for MoE layers (<code class="docutils literal notranslate"><span class="pre">--ep</span> <span class="pre">8</span> <span class="pre">--moe-a2a-backend</span> <span class="pre">deepep</span></code>)</p></li>
<li><p>Use <strong>SMG</strong> with <strong>cache_aware</strong> policy</p></li>
</ol>
<p><strong>Related documentation:</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="expert_parallelism.html"><span class="std std-doc">Expert Parallelism</span></a> - DeepEP, Two-Batch Overlap, EPLB</p></li>
<li><p><a class="reference internal" href="sgl_model_gateway.html"><span class="std std-doc">SGLang Model Gateway Documentation</span></a> - SMG configuration &amp; troubleshooting</p></li>
<li><p><a class="reference external" href="https://lmsys.org/blog/2025-05-05-large-scale-ep/">Large-Scale EP Blog</a> - 96 GPU deployment guide</p></li>
</ul>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="expert_parallelism.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Expert Parallelism</p>
      </div>
    </a>
    <a class="right-next"
       href="lora.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">LoRA Serving</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-parallelism-dp">Data Parallelism (DP)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-characteristics">Key characteristics</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-parallelism-attention-dpa">Data Parallelism Attention (DPA)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-problem-with-tensor-parallelism-for-mla-models">The Problem with Tensor Parallelism for MLA Models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-dpa-works">How DPA Works</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#communication-patterns-in-dpa-ep"><strong>Communication patterns in DPA + EP:</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-benefits-of-dpa">Key benefits of DPA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dpa-with-expert-parallelism-for-moe">DPA with Expert Parallelism for MoE</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recommended-setup-for-deepseek">Recommended setup for DeepSeek</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#target-models">Target Models</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#activation-logic">Activation Logic</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#standard-dp-for-mla-models">Standard DP for MLA models</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modern-data-parallelism-sglang-model-gateway-smg">Modern Data Parallelism SGLang Model Gateway (SMG)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#native-dp-mode">Native DP Mode</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#smg-based-dp-recommended">SMG-Based DP (Recommended)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#smg-s-performance">SMG’s Performance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#when-to-use-each">When to Use Each</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#quick-start-for-smg">Quick Start For SMG</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-balancing-policies">Load Balancing Policies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#best-practices">Best Practices</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verifying-traffic-distribution">Verifying Traffic Distribution</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reference">Reference</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By SGLang Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023-2026, SGLang.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    <p class="last-updated">
  Last updated on Feb 26, 2026.
  <br/>
</p>
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  
    <!-- RunLLM Widget Script -->
    <script type="module" id="runllm-widget-script" src="https://widget.runllm.com" crossorigin="true" version="stable" runllm-keyboard-shortcut="Mod+j" runllm-name="SGLang Chatbot" runllm-position="BOTTOM_RIGHT" runllm-assistant-id="629" async></script>
    
</body>
</html>